## UDP -- 用户数据报协议

---

## 目录


* [简介](#简介)
* [首部格式](#首部格式)
* [UDP校验和](#udp校验和)
* [IP分片](#ip分片)
	* [IP数据报和分组的概念](#ip数据报和分组的概念)
* [ICMP不可达差错](#icmp不可达差错)
* [最大UDP数据报长度](#最大udp数据报长度)
* [数据报截断](#数据报截断)
* [ICMP源站抑制差错](#icmp源站抑制差错)
* [UDP分片除最后一个分片外，其他分片的数据长度均要求为8字节的整数倍的原因](#udp分片除最后一个分片外其他分片的数据长度均要求为8字节的整数倍的原因)

***

### 简介
  &emsp; UDP是一个简单的面向数据报的**运输层**协议。其具有如下特点：

- 无连接
- 不保证数据到达目的端
- 数据有边界
- 系统资源占用少

进程**每个输出都产生一个UDP数据报**，TCP应用程序产生的全体数据 与真正发送的单个IP数据报没有这样的关系。  

### 首部格式

![UDP首部格式] [udp-header]

&emsp; UDP首部长度共**8字节**,**伪首部**不属于首部，只是**为了计算校验和**而设置的，UDP首部格式说明如下:  
- *16位源端口号*  
- *16位目的端口号*  
  > 用以识别源主机和目的主机中的发送和接收应用程序；其中，0-1024一般为系统应用使用；  

- *UDP总长度*  
  > 总长度包括: *UDP首部长度*和*UDP数据长度*;最小值为8字节，允许发送一份0字节的UDP数据报  

- *UDP校验和* 
  > - **UDP的校验和是可选的，TCP的校验和是必需的**；
  > - 校验和覆盖UDP首部和UDP数据;  
  > - UDP校验和是一个**端对端**的校验和，由**发送端计算**，**接收端验证**;
  > - 这样校验是为了发现UDP首部和UDP数据在发送端到接收端之间是否发生改动;

### UDP校验和
**UDP校验和覆盖UDP首部和UDP数据**，而IP首部的校验和**只覆盖IP首部，不覆盖数据**。  
校验和算法是：把若干16bit字相加。UDP数据报长度可以为奇数字节，解决方法是必要时在最后增加填充字节0，这只是为了校验和的计算，不会被传送。  
同时，UDP数据报和TCP段都包含一个12字节长的伪首部，它是为了计算校验和而设置的。  
如果校验和的计算结果为0，则存入的值为全1(65535)。如果传送的校验和为0，则说明发送端没有计算校验和。  
UDP校验和是可选的，如NFS(Newwork File System)为了提升UDP的速度关闭UDP校验和计算。  
注意，TCP发生校验和差错的比例与UDP相比要高得多。这很可能是因为系统中TCP连接经常是“远程”连接，需要经过许多路由器和交换机等中间设备，而UDP一般为本地通信。  

#### UDP伪首部作用
UDP数据报和TCP段都包含一个12字节长的伪首部，它的目的是计算校验和而设置的，让UDP和TCP**两次**检查数据是否已经正确到达目的地。  
两次校验为(伪首部字段包含：32源IP地址，32位目的IP地址，8位协议，16位UDP长度)：

- 第一次：通过伪首部中的IP地址校验，UDP可以确定该数据报是不是发送给本地IP地址的；
- 第二次，通过伪首部中的协议字段校验，UDP可以确认IP是否把不该传给UDP而应该传给别的高层的数据传给了UDP；

### IP分片
&emsp; 应用程序必须关心IP数据报的长度，如果它超过网络的MTU，就需要对数据报进行分片：

- 分片可发生在主机，也可发生在路由器；
- 分片只有到达目的地才开始重组；
- 重组发生在接收端IP层；
  > 在IP层重组的目的是：** 使分片和重新组装过程对运输层(TCP、UDP等) **是透明的，以及防止某些可能的性能降低;

- 重组的依据是IP首部的唯一标识和偏移量；
  >IP标志字段被复制到每个分片中,除最后一个分片外，其他每个分片的数据部分必须是8的倍数；
- 分片的数据报到达目的端时有可能会失序
  >但是根据IP首部中的唯一标志字段、DF标志和段偏移量可以正确重组分片
- 如果数据报应该分片，但是IP首部中DF标志被置为1，则IP不对数据报进行分片，而是丢弃数据报并向发送端发送一份*ICMP差错报文*("需要分片但设置了不分片标志")；
- 除最后一个分片外，其他分片的数据部分长度必须是8的倍数；
- **出现分片时，任何运输层协议首部只出现在第一个分片中**；
- 即使只丢失一个分片的数据，也要重新传整个数据报；
- 如果对数据分片的是中间路由器，而不是起始端系统，那么起始端系统就无法知道数据报是如何被分片的。因为这个原因，需要尽量避免IP报分片；
- IP数据报分片后，每一个分片都称为一个组，具有自己的IP首部；

#### IP数据报和分组的概念
**IP数据报**：是指IP层端到端的传输单元；  
**分组**：是IP层和链路层之间传送的数据单元；  
一个分组可以是一个完整的IP数据报，也可以是一个IP数据报的一个分片。  

### ICMP不可达差错
当路由器接收到一份需要分片的数据，而在IP数据首部中又设置了不分片(DF)的标志时，路由器就会向发送端发送ICMP不可达差错。  

### 最大UDP数据报长度
&emsp; 理论上，IP数据报的最大长度是65535字节，除去IP和UDP首部长度，UDP最大理论长度为(65535-20-8=65507)字节。但实际中，UDP最大报文长度主要受两个因素限制：
- 受应用程序接口限制
  > `socket` API提供了一个可供应用程序调用的函数，以设置接收和发送缓冲的长度。大部分系统可读写大于8192字节的UDP数据报。  

- 受TCP/IP内核实现限制

### 数据报截断
&emsp; 原因：**接收到的数据报长度大于应用程序所能处理的长度**  
&emsp; 处理：接收所能处理数据，**丢弃任何多余的数据**   

### ICMP源站抑制差错
&emsp; 原因：接收数据报的速度大于其处理速度，**可能**会出现该差错  

### UDP分片除最后一个分片外，其他分片的数据长度均要求为8字节的整数倍的原因
这是因为IP首部中偏移量的偏移单位是8字节。这是由IP首部中的**长度(16bit)** 和 **偏移量(13bit)** 两个字段决定的。  
总长度：定义了IP数据报的最大长度2^16字节；  
偏移量：定义了偏移量的最大长度为2^13字节；  
为了偏移量能表示出IP报的最大长度，偏移量的偏移单位应该是 2^16 / 2^13 = 2^3(8字节)。

[udp-header]: http://img.blog.163.com/photo/ClsVRVH0XILM6B1e75e7_w==/4512325351649529051.jpg "UDP首部格式"


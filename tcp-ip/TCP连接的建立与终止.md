## TCP连接的建立与终止
- - -

### 目录 


* [连接的建立与终止](#连接的建立与终止)
	* [为什么是三次握手而不是两次或者四次](#为什么是三次握手而不是两次或者四次)
* [四次挥手](#四次挥手)
* [连接建立的超时](#连接建立的超时)
* [最大报文段长度 ](#最大报文段长度-)
* [TCP的半关闭](#tcp的半关闭)
* [TCP状态变迁图](#tcp状态变迁图)
	* [2MSL等待状态](#2msl等待状态)
	* [平静时间的概念](#平静时间的概念)
* [复位报文段](#复位报文段)
	* [半打开连接](#半打开连接)

* * *

### 连接的建立与终止
**三次握手**：  

- 请求端发送一个SYN段指明打算连接的服务器的端口。同时初始化序列号ISN(SYN位置为1)。
- 服务端发送包含服务器初始序列号的SYN报文作为应答。同时，将确认号设置为客户ISN加1以对客户的SYN报文段进行确认(SYN为1，ACK为1)。
- 客户必须将确认序号设置为服务器初始化ISN加1对服务器的SYN报文段进行确认。

其中，ISN初始化序列号随时间的变化而变化，因此每个TCP连接的初始化序列号不同。  
ISN可以看做是一个32比特的计数器，每**4ms**加1.这样选择序号的目的是：**防止网络中被延迟的分组在以后又被传送，而导致某个连接的一方对它做错误的解释**。

#### 为什么是三次握手而不是两次或者四次
使用对讲机原理进行理解：  
第一次握手C->S：你能听到吗？  
第二次握手S->C：听到。你能听到我吗?  
第三次握手C->S：听到。  

### 四次挥手
TCP四次挥手是由TCP的半关闭造成的。既然TCP连接是全双工的，因此每个方向上必须单独地进行关闭。  
收到一个FIN只意味着在这个方向上没有数据流量，但是仍然可以发送数据。

### 连接建立的超时
建立一个TCP连接的最长时间限制为75秒。  

### 最大报文段长度  

- 最大报文段长度MSS表示TCP**传往另一端的最大块数据的长度**。   
- 当一个TCP连接建立时，连接的双方都要通告自己的MSS。  
- **MSS选项**只能出现在**SYN报文段**中。  
- 如果一方不接收来自另一方的MSS值，则MSS值就被定为**默认值536字节**。
- 一般来说，没有分段发生，MSS还是越大越好，这样有利于网络利用率。  
- 当TCP发送一个SYN时，或者因为一个本地应用进程想发起一个连接，或者因为另一端的主机收到一个连接请求时，它将MSS值设置为外出接口上的MTU值减去固定IP首部和TCP首部长度。对于以太网来说，MSS值可达1460(1500-20-20)。  
- 如果目的IP地址是**非本地的**，MSS通常的值为536。  

### TCP的半关闭 

- TCP提供了连接的一端在结束它的发送后还能接收来自另一端数据的能力，这就是TCP的半关闭。  
- `socket` API中使用`shutdown`函数可以实现半关闭。  

### TCP状态变迁图
TCP客户端：  
SYN_SENT->ESTABLISHED->FIN_WAIT1->FIN_WAIT2->TIME_WAIT   
TCP服务端：  
SYN_REVD->ESTABLISHED->CLOSE_WAIT->LAST_ACK->CLOSED  

#### 2MSL等待状态

- TIME_WAIT状态称为2MSL等待状态。  
- 每个具体TCP实现必须选择一个报文段最大生存时间MSL(Maximum Segment Lifetime)。它是任何报文段被丢弃前在网络中的最长时间。该值常用值为30秒，1分钟或2分钟。  
- 当TCP执行一个主动关闭时，并发回最后一个ACK，该连接必须在TIME_WAIT状态停留的时间为2倍的MSL。这样可以让TCP再次发送最后的ACK以防这个ACK丢失（另一端超时并重发最后的FIN）

#### 平静时间的概念
TCP在重新启动后的MSL秒内不能建立任何连接，这就是平静时间。  

### 复位报文段 
TCP产生RST报文段的情况：  

- 当连接请求到达时，目的端口没有进程在监听。  
- 异常终止一个连接。  
- 客户主机突然掉电好。   

#### 半打开连接
如果一方已经关闭或者异常关闭而另一方还不知道，则将这样的TCP连接称之为**半打开的**。
